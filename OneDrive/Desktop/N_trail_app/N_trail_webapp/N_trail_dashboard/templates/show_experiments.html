

{% extends 'base.html' %}

{% block content %}
<h1>Experiments for Project: {{ project.Project_ID }}</h1>

<!-- Display Project Table -->
<table border="1">
  <tr>
    <th>Experiment ID</th>
    <th>Project ID</th>
    <th>Location ID</th>
    <th>Year</th>
    <th>Interaction 1 Count</th>
    <th>Interaction 1 Count 1</th>
    <th>Interaction 1 Count 2</th>
    <th>Interaction 1 Count 3</th>
    <th>Interaction 1 Count 4</th>
    <th>Interaction 1 Count 5</th>
    <th>Interaction 2 Count</th>
    <th>Interaction 2 Count 1</th>
    <th>Interaction 2 Count 2</th>
    <th>Interaction 2 Count 3</th>
    <th>Interaction 2 Count 4</th>
    <th>Interaction 2 Count 5</th>
    <th>Interaction 3 Count</th>
    <th>Interaction 3 Count 1</th>
    <th>Interaction 3 Count 2</th>
    <th>Interaction 3 Count 3</th>
    <th>Interaction 3 Count 4</th>
    <th>Interaction 3 Count 5</th>
    <th>Metadata</th>
    <th>Treatments</th> 
  </tr>
  {% for experiment in experiments %}
  <tr>
    <td>{{ experiment.Experiment_ID }}</td>
    <td>{{ experiment.Project_ID }}</td>
    <td>{{ experiment.Location_ID }}</td>
    <td>{{ experiment.Year }}</td>
    <td>{{ experiment.Interaction_1_count}}</td>
    <td>{{ experiment.Interaction_1_count_1}}</td>
    <td>{{ experiment.Interaction_1_count_2}}</td>
    <td>{{ experiment.Interaction_1_count_3}}</td>
    <td>{{ experiment.Interaction_1_count_4}}</td>
    <td>{{ experiment.Interaction_1_count_5}}</td>
    <td>{{ experiment.Interaction_2_count}}</td>
    <td>{{ experiment.Interaction_2_count_1}}</td>
    <td>{{ experiment.Interaction_2_count_2}}</td>
    <td>{{ experiment.Interaction_2_count_3}}</td>
    <td>{{ experiment.Interaction_2_count_4}}</td>
    <td>{{ experiment.Interaction_2_count_5}}</td>
    <td>{{ experiment.Interaction_3_count}}</td>
    <td>{{ experiment.Interaction_3_count_1}}</td>
    <td>{{ experiment.Interaction_3_count_2}}</td>
    <td>{{ experiment.Interaction_3_count_3}}</td>
    <td>{{ experiment.Interaction_3_count_4}}</td>
    <td>{{ experiment.Interaction_3_count_5}}</td>
    <td>{{ experiment.MetaData }}</td>
    <td><a href="{% url 'show_treatments' experiment_id=experiment.Experiment_ID %}">Show</a></td>
  </tr>
  {% endfor %}
</table>

<!-- Add experiment Button -->
<button id="add-experiment-button">Add Experiment</button>
<div id="experiment-actions" style="display: none;">
  <select id="experiment-action-select">
    <option value="none">Select</option>
    <option value="add">Add New Experiment</option>
    <option value="import">Import Experiment</option>
  </select>
</div>

<!-- Add Experiment Form -->
<div id="add-experiment-form" style="display: none;">
  <h2>Add Experiment Details</h2>
  <form method="post" id="experiment-form" class="experiment-form">
    {% csrf_token %}

    <label for="Project_ID">Project ID:</label>
    <input type="text" id="Project_ID" name="Project_ID" value="{{ project.Project_ID }}" required><br>
    <label for="Experiment_ID">Experiment ID:</label>
    <input type="text" id="Experiment_ID" name="Experiment_ID" required><br>

    <label for="Year">Year:</label>
    <input type="text" id="Year" name="Year" required><br>

    <!-- Location dropdown -->
    <label for="Location_ID">Location ID:</label>
    <select id="Location_ID" name="Location_ID">
      {% for choice in location_choices %}
      <option value="{{ choice.0 }}">{{ choice.1 }}</option>
      {% endfor %}
    </select><br>

    {% if project.Interaction_1 %}
    <label for="Interaction_1_count">Interaction 1 Count ({{ project.Interaction_1 }}):</label>
    <input type="number" id="Interaction_1_count" name="Interaction_1_count"><br>
    <div>
      <input type="radio" id="interaction_1_class" name="interaction_1_type" value="class">
      <label for="interaction_1_class">Class</label>
      <input type="radio" id="interaction_1_continuous" name="interaction_1_type" value="continuous">
      <label for="interaction_1_continuous">Continuous</label>
    </div>
    <div id="interaction_1-fields"></div>
    {% endif %}

    {% if project.Interaction_2 %}
    <label for="Interaction_2_count">Interaction 2 Count ({{ project.Interaction_2 }}):</label>
    <input type="number" id="Interaction_2_count" name="Interaction_2_count"><br>
    <div>
      <input type="radio" id="interaction_2_class" name="interaction_2_type" value="class">
      <label for="interaction_2_class">Class</label>
      <input type="radio" id="interaction_2_continuous" name="interaction_2_type" value="continuous">
      <label for="interaction_2_continuous">Continuous</label>
    </div>
    <div id="interaction_2-fields"></div>
    {% endif %}

    {% if project.Interaction_3 %}
    <label for="Interaction_3_count">Interaction 3 Count ({{ project.Interaction_3 }}):</label>
    <input type="number" id="Interaction_3_count" name="Interaction_3_count"><br>
    <div>
      <input type="radio" id="interaction_3_class" name="interaction_3_type" value="class">
      <label for="interaction_3_class">Class</label>
      <input type="radio" id="interaction_3_continuous" name="interaction_3_type" value="continuous">
      <label for="interaction_3_continuous">Continuous</label>
    </div>
    <div id="interaction_3-fields"></div>
    {% endif %}

    <label for="MetaData">Metadata:</label>
    <textarea id="MetaData" name="MetaData" rows="4" cols="50"></textarea><br>

    <label for="ManualSubmit">Manual Submit</label>
    <input type="checkbox" id="ManualSubmit">

    <button type="submit">Generate Treatments</button>
    <span id="success-message" style="color: green; display: none;">Experiment added successfully!</span>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Interaction mapping
  const interactionMapping = {
    'Timing': ['fall', 'spring'],
    'Inhibitor': ['V6', 'centuro', 'nitrapyrin'],
    'N_rate': ['high', 'low', 'medium'],
    'Landscape': ['flat', 'tilt'],
    'Biological': ['provenN', 'utrishaN', 'NA'],
    'Cover_Crop': ['withcrop', 'withoutcrop', 'corncrop'],
    'Crop_Rotation': ['peanut', 'cotton'],
    'Fall_N_Rate': ['10', '20', '30'],
    'Previous_N_Rate': ['11', '12', '13'],
    'Grazing': ['yes', 'no', 'na'],
    'Spring_N_Rate': ['4', '6', '5'],
    'NA': ['NA'],
    'Select': ['Select']
  };

  const unitOptions = ['u1', 'u2', 'u3','na'];

  // Function to update interaction fields dynamically
  function updateInteractionFields(countId, fieldsContainerId, fieldPrefix, interactionType, fieldType) {
    const countValue = parseInt(document.getElementById(countId).value);
    const fieldsContainer = document.getElementById(fieldsContainerId);
    fieldsContainer.innerHTML = ''; // Clear existing fields

    for (let i = 1; i <= countValue; i++) {
      const label = document.createElement('label');
      label.textContent = `${fieldPrefix.replace('_', ' ')} ${i}: `;
      fieldsContainer.appendChild(label);

      if (fieldType === 'continuous') {
        const input = document.createElement('input');
        input.type = 'text';
        input.name = `${fieldPrefix}_${i}`;
        input.id = `${fieldPrefix}_${i}`;
        fieldsContainer.appendChild(input);

        const unitSelect = document.createElement('select');
        unitSelect.name = `${fieldPrefix}_${i}_unit`;
        unitSelect.id = `${fieldPrefix}_${i}_unit`;
        unitOptions.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option;
          optionElement.textContent = option;
          unitSelect.appendChild(optionElement);
        });
        fieldsContainer.appendChild(unitSelect);
      } else if (fieldType === 'class') {
        const select = document.createElement('select');
        const fieldName = `${fieldPrefix}_${i}`;
        select.name = fieldName;
        select.id = fieldName;
        const options = interactionMapping[interactionType] || [];
        options.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option;
          optionElement.textContent = option;
          select.appendChild(optionElement);
        });
        fieldsContainer.appendChild(select);
      }
      fieldsContainer.appendChild(document.createElement('br'));
    }
  }

  // Show the add experiment form when the button is clicked
  document.querySelector('#add-experiment-button').addEventListener('click', function() {
    document.querySelector('#experiment-actions').style.display = 'block';
  });

  // Handle dropdown selection
  document.querySelector('#experiment-action-select').addEventListener('change', function() {
    const action = this.value;
    if (action === 'add') {
      document.querySelector('#add-experiment-form').style.display = 'block';
    } else {
      document.querySelector('#add-experiment-form').style.display = 'none';
    }
  });

  // Handle form submission
  document.querySelector('#experiment-form').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent the default form submission

    const formData = new FormData(this);
    // Sends a POST request to the server-side URL
    fetch('{% url "add_experiment" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const experimentID = formData.get('Experiment_ID');
        // Redirect to the show_treatments page
        window.location.href = `{% url 'show_treatments' experiment_id='EXPERIMENT_ID_PLACEHOLDER' %}`.replace('EXPERIMENT_ID_PLACEHOLDER', experimentID);
      } else {
        alert('Failed to add experiment: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to add experiment. Please try again.');
    });
  });

  // Event listeners for interaction count fields and type selection
  document.getElementById('Interaction_1_count')?.addEventListener('change', function() {
    const interactionType = "{{ project.Interaction_1 }}";
    const fieldType = document.querySelector('input[name="interaction_1_type"]:checked')?.value;
    if (fieldType) {
      updateInteractionFields('Interaction_1_count', 'interaction_1-fields', 'Interaction_1_count', interactionType, fieldType);
    }
  });

  document.querySelectorAll('input[name="interaction_1_type"]').forEach(element => {
    element.addEventListener('change', function() {
      const interactionType = "{{ project.Interaction_1 }}";
      const fieldType = this.value;
      const countValue = parseInt(document.getElementById('Interaction_1_count').value);
      if (countValue) {
        updateInteractionFields('Interaction_1_count', 'interaction_1-fields', 'Interaction_1_count', interactionType, fieldType);
      }
    });
  });

  document.querySelectorAll('input[name="interaction_2_type"]').forEach(element => {
    element.addEventListener('change', function() {
      const interactionType = "{{ project.Interaction_2 }}";
      const fieldType = this.value;
      const countValue = parseInt(document.getElementById('Interaction_2_count').value);
      if (countValue) {
        updateInteractionFields('Interaction_2_count', 'interaction_2-fields', 'Interaction_2_count', interactionType, fieldType);
      }
    });
  });

  document.querySelectorAll('input[name="interaction_3_type"]').forEach(element => {
    element.addEventListener('change', function() {
      const interactionType = "{{ project.Interaction_3 }}";
      const fieldType = this.value;
      const countValue = parseInt(document.getElementById('Interaction_3_count').value);
      if (countValue) {
        updateInteractionFields('Interaction_3_count', 'interaction_3-fields', 'Interaction_3_count', interactionType, fieldType);
      }
    });
  });

});
</script>


  
{% endblock %}
