{% extends 'base.html' %}

{% block content %}
<h1>Experiments for Project: {{ project.Project_ID }}</h1>

<!-- Display Project Table -->
<table border="1">
  <tr>
    <th>Experiment ID</th>
    <th>Project ID</th>
    <th>Location ID</th>
    <th>Year</th>
    <th>Interaction 1 Count</th>
    <th>Interaction 1 Value</th>
    <th>Interaction 2 Count</th>
    <th>Interaction 2 Value</th>
    <th>Interaction 3 Count</th>
    <th>Interaction 3 Value</th>
    <th>Yield Map</th>
    <th>Soil Sample</th>
    <th>Sonic Sensor</th>
    <th>GCP</th>
    <th>RAW UAV</th>
    <th>Orthomosic UAV</th>
    <th>DSM UAV</th>
    <th>Orthomosic SAT</th>
    <th>DSM SAT</th>
    <th>VI 1</th>
    <th>VI 2</th>
    <th>VI 3</th>
    <th>Metadata</th>
    <th>Treatments</th>
  </tr>
  {% for experiment in experiments %}
  <tr>
    <td>{{ experiment.Experiment_ID }}</td>
    <td>{{ experiment.Project_ID }}</td>
    <td>{{ experiment.Location_ID }}</td>
    <td>{{ experiment.Year }}</td>
    <td>{{ experiment.Interaction_1_count }}</td>
    <td>{{ experiment.Interaction_1_value }}</td>
    <td>{{ experiment.Interaction_2_count }}</td>
    <td>{{ experiment.Interaction_2_value }}</td>
    <td>{{ experiment.Interaction_3_count }}</td>
    <td>{{ experiment.Interaction_3_value }}</td>
    <td>{{ experiment.Yield_Map }}</td>
    <td>{{ experiment.Soil_Sample }}</td>
    <td>{{ experiment.Sonic_sensor }}</td>
    <td>{{ experiment.GCP }}</td>
    <td>{{ experiment.RAWUAV }}</td>
    <td>{{ experiment.Orthomosic_UAV }}</td>
    <td>{{ experiment.DSM_UAV }}</td>
    <td>{{ experiment.Orthomosic_SAT }}</td>
    <td>{{ experiment.DSM_SAT }}</td>
    <td>{{ experiment.VI_1 }}</td>
    <td>{{ experiment.VI_2 }}</td>
    <td>{{ experiment.VI_3 }}</td>
    <td>{{ experiment.MetaData }}</td>
    <td><a href="{% url 'show_treatments' experiment_id=experiment.Experiment_ID %}">Show</a></td>
  </tr>
  {% endfor %}
</table>

<!-- Add experiment Button -->
<button id="add-experiment-button">Add Experiment</button>
<div id="experiment-actions" style="display: none;">
  <select id="experiment-action-select">
    <option value="none">Select</option>
    <option value="add">Add New Experiment</option>
    <option value="import">Import Experiment</option>
  </select>
</div>

<!-- Add Experiment Form -->
<div id="add-experiment-form" style="display: none;">
  <h2>Add Experiment Details</h2>
  <form method="post" id="experiment-form" action="{% url 'add_experiment' %}">
    {% csrf_token %}

    <label for="Project_ID">Project ID:</label>
    <input type="text" id="Project_ID" name="Project_ID" value="{{ project.Project_ID }}" required><br>
    <label for="Experiment_ID">Experiment ID:</label>
    <input type="text" id="Experiment_ID" name="Experiment_ID" required><br>

    <label for="Year">Year:</label>
    <input type="text" id="Year" name="Year" required><br>

    <label for="Location_ID">Location ID:</label>
    <select id="Location_ID" name="Location_ID">
      {% for choice in location_choices %}
      <option value="{{ choice.0 }}">{{ choice.1 }}</option>
      {% endfor %}
      <option value="other">Other</option>
    </select><br>

    <!-- New Location Fields -->
    <div id="new-location-fields" style="display: none;">
      <h3>Add New Location</h3>
      <label for="New_Location_ID">New Location ID:</label>
      <input type="text" id="New_Location_ID" name="New_Location_ID"><br>

      <label for="New_State">State:</label>
      <input type="text" id="New_State" name="New_State"><br>

      <label for="New_County">County:</label>
      <input type="text" id="New_County" name="New_County"><br>

      <label for="New_Owner">Owner:</label>
      <input type="text" id="New_Owner" name="New_Owner"><br>

      <label for="New_Latitude">Latitude:</label>
      <input type="text" id="New_Latitude" name="New_Latitude"><br>

      <label for="New_Longitude">Longitude:</label>
      <input type="text" id="New_Longitude" name="New_Longitude"><br>

      <label for="New_Contact">Contact:</label>
      <input type="text" id="New_Contact" name="New_Contact"><br>

      <label for="New_MetaData">Metadata:</label>
      <textarea id="New_MetaData" name="New_MetaData" rows="4" cols="50"></textarea><br>
    </div>

    {% if project.Interaction_1 %}
    <label for="Interaction_1_count">Interaction 1 Count ({{ project.Interaction_1 }}):</label>
    <input type="number" id="Interaction_1_count" name="Interaction_1_count"><br>
    <div>
      <input type="radio" id="interaction_1_class" name="interaction_1_type" value="class">
      <label for="interaction_1_class">Class</label>
      <input type="radio" id="interaction_1_continuous" name="interaction_1_type" value="continuous">
      <label for="interaction_1_continuous">Continuous</label>
    </div>
    <div id="interaction_1-fields"></div>
    {% endif %}

    {% if project.Interaction_2 %}
    <label for="Interaction_2_count">Interaction 2 Count ({{ project.Interaction_2 }}):</label>
    <input type="number" id="Interaction_2_count" name="Interaction_2_count"><br>
    <div>
      <input type="radio" id="interaction_2_class" name="interaction_2_type" value="class">
      <label for="interaction_2_class">Class</label>
      <input type="radio" id="interaction_2_continuous" name="interaction_2_type" value="continuous">
      <label for="interaction_2_continuous">Continuous</label>
    </div>
    <div id="interaction_2-fields"></div>
    {% endif %}

    {% if project.Interaction_3 %}
    <label for="Interaction_3_count">Interaction 3 Count ({{ project.Interaction_3 }}):</label>
    <input type="number" id="Interaction_3_count" name="Interaction_3_count"><br>
    <div>
      <input type="radio" id="interaction_3_class" name="interaction_3_type" value="class">
      <label for="interaction_3_class">Class</label>
      <input type="radio" id="interaction_3_continuous" name="interaction_3_type" value="continuous">
      <label for="interaction_3_continuous">Continuous</label>
    </div>
    <div id="interaction_3-fields"></div>
    {% endif %}

    <label for="Yield_Map">Yield Map:</label>
    <textarea id="Yield_Map" name="Yield_Map" rows="4" cols="50"></textarea><br>

    <label for="Soil_Sample">Soil Sample:</label>
    <textarea id="Soil_Sample" name="Soil_Sample" rows="4" cols="50"></textarea><br>

    <label for="Sonic_sensor">Sonic Sensor:</label>
    <textarea id="Sonic_sensor" name="Sonic_sensor" rows="4" cols="50"></textarea><br>

    <label for="GCP">GCP:</label>
    <textarea id="GCP" name="GCP" rows="4" cols="50"></textarea><br>

    <label for="RAWUAV">RAW UAV:</label>
    <textarea id="RAWUAV" name="RAWUAV" rows="4" cols="50"></textarea><br>

    <label for="Orthomosic_UAV">Orthomosic UAV:</label>
    <textarea id="Orthomosic_UAV" name="Orthomosic_UAV" rows="4" cols="50"></textarea><br>

    <label for="DSM_UAV">DSM UAV:</label>
    <textarea id="DSM_UAV" name="DSM_UAV" rows="4" cols="50"></textarea><br>

    <label for="Orthomosic_SAT">Orthomosic SAT:</label>
    <textarea id="Orthomosic_SAT" name="Orthomosic_SAT" rows="4" cols="50"></textarea><br>

    <label for="DSM_SAT">DSM SAT:</label>
    <textarea id="DSM_SAT" name="DSM_SAT" rows="4" cols="50"></textarea><br>

    <label for="VI_1">VI 1:</label>
    <textarea id="VI_1" name="VI_1" rows="4" cols="50"></textarea><br>

    <label for="VI_2">VI 2:</label>
    <textarea id="VI_2" name="VI_2" rows="4" cols="50"></textarea><br>

    <label for="VI_3">VI 3:</label>
    <textarea id="VI_3" name="VI_3" rows="4" cols="50"></textarea><br>

    <label for="MetaData">Metadata:</label>
    <textarea id="MetaData" name="MetaData" rows="4" cols="50"></textarea><br>

    <label for="ManualSubmit">Manual Submit</label>
    <input type="checkbox" id="ManualSubmit">

    <button type="submit">Generate Treatments</button>
    <span id="success-message" style="color: green; display: none;">Experiment added successfully!</span>
  </form>
</div>

<!-- Import Experiment Form -->
<div id="import-experiment-form" style="display: none;">
  <h2>Import Experiments</h2>
  <form method="post" id="import-form" enctype="multipart/form-data">
    {% csrf_token %}
    <label for="csv_file">Upload CSV file:</label>
    <input type="file" id="csv_file" name="csv_file" accept=".csv" required><br>
    <button type="submit">Import</button>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const unitOptions = ['u1', 'u2', 'u3', 'na'];

  function updateInteractionFields(countId, fieldsContainerId, fieldPrefix, fieldType) {
    const countValue = parseInt(document.getElementById(countId).value);
    const fieldsContainer = document.getElementById(fieldsContainerId);
    fieldsContainer.innerHTML = ''; // Clear existing fields

    if (fieldType === 'continuous') {
      const unitSelect = document.createElement('select');
      unitSelect.name = `${fieldPrefix}_unit`;
      unitSelect.id = `${fieldPrefix}_unit`;
      unitOptions.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        unitSelect.appendChild(optionElement);
      });
      fieldsContainer.appendChild(unitSelect);
      fieldsContainer.appendChild(document.createElement('br'));
    }

    for (let i = 1; i <= countValue; i++) {
      const label = document.createElement('label');
      label.textContent = `${fieldPrefix.replace('_', ' ')} ${i}: `;
      fieldsContainer.appendChild(label);

      const input = document.createElement('input');
      input.type = 'text';
      input.name = `${fieldPrefix}_${i}`;
      input.id = `${fieldPrefix}_${i}`;
      fieldsContainer.appendChild(input);

      fieldsContainer.appendChild(document.createElement('br'));
    }
  }

  document.querySelector('#add-experiment-button').addEventListener('click', function() {
    document.querySelector('#experiment-actions').style.display = 'block';
  });

  document.querySelector('#experiment-action-select').addEventListener('change', function() {
    const action = this.value;
    if (action === 'add') {
      document.querySelector('#add-experiment-form').style.display = 'block';
    } else {
      document.querySelector('#add-experiment-form').style.display = 'none';
    }

    if (action === 'import') {
      document.querySelector('#import-experiment-form').style.display = 'block';
    } else {
      document.querySelector('#import-experiment-form').style.display = 'none';
    }
  });

  document.querySelector('#experiment-form').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent the default form submission

    const formData = new FormData(this);

    const interaction1Values = [];
    const interaction1Units = document.getElementById('Interaction_1_unit')?.value;
    if (interaction1Units) formData.set('Interaction_1_unit', interaction1Units);
    document.querySelectorAll('#interaction_1-fields input').forEach(input => {
      interaction1Values.push(input.value);
    });
    formData.set('Interaction_1_value', interaction1Values.join(','));

    const interaction2Values = [];
    const interaction2Units = document.getElementById('Interaction_2_unit')?.value;
    if (interaction2Units) formData.set('Interaction_2_unit', interaction2Units);
    document.querySelectorAll('#interaction_2-fields input').forEach(input => {
      interaction2Values.push(input.value);
    });
    formData.set('Interaction_2_value', interaction2Values.join(','));

    const interaction3Values = [];
    const interaction3Units = document.getElementById('Interaction_3_unit')?.value;
    if (interaction3Units) formData.set('Interaction_3_unit', interaction3Units);
    document.querySelectorAll('#interaction_3-fields input').forEach(input => {
      interaction3Values.push(input.value);
    });
    formData.set('Interaction_3_value', interaction3Values.join(','));

    fetch('{% url "add_experiment" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const experimentID = formData.get('Experiment_ID');
        window.location.href = `{% url 'show_treatments' experiment_id='EXPERIMENT_ID_PLACEHOLDER' %}`.replace('EXPERIMENT_ID_PLACEHOLDER', experimentID);
      } else {
        alert('Failed to add experiment: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to add experiment. Please try again.');
    });
  });

  document.getElementById('import-form').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent the default form submission

    const formData = new FormData(this);
    fetch('{% url "import_experiment" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Experiments imported successfully!');
        window.location.reload(); // Reload the page to reflect changes
      } else {
        alert('Failed to import experiments: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to import experiments. Please try again.');
    });
  });

  document.getElementById('Location_ID').addEventListener('change', function() {
    const newLocationFields = document.getElementById('new-location-fields');
    if (this.value === 'other') {
      newLocationFields.style.display = 'block';
    } else {
      newLocationFields.style.display = 'none';
    }
  });

  document.getElementById('Interaction_1_count')?.addEventListener('change', function() {
    const fieldType = document.querySelector('input[name="interaction_1_type"]:checked')?.value;
    if (fieldType) {
      updateInteractionFields('Interaction_1_count', 'interaction_1-fields', 'Interaction_1', fieldType);
    }
  });

  document.querySelectorAll('input[name="interaction_1_type"]').forEach(element => {
    element.addEventListener('change', function() {
      const fieldType = this.value;
      const countValue = parseInt(document.getElementById('Interaction_1_count').value);
      if (countValue) {
        updateInteractionFields('Interaction_1_count', 'interaction_1-fields', 'Interaction_1', fieldType);
      }
    });
  });

  document.querySelectorAll('input[name="interaction_2_type"]').forEach(element => {
    element.addEventListener('change', function() {
      const fieldType = this.value;
      const countValue = parseInt(document.getElementById('Interaction_2_count').value);
      if (countValue) {
        updateInteractionFields('Interaction_2_count', 'interaction_2-fields', 'Interaction_2', fieldType);
      }
    });
  });

  document.querySelectorAll('input[name="interaction_3_type"]').forEach(element => {
    element.addEventListener('change', function() {
      const fieldType = this.value;
      const countValue = parseInt(document.getElementById('Interaction_3_count').value);
      if (countValue) {
        updateInteractionFields('Interaction_3_count', 'interaction_3-fields', 'Interaction_3', fieldType);
      }
    });
  });

});
</script>

{% endblock %}
