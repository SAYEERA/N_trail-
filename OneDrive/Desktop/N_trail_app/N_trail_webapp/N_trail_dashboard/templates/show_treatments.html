{% load custom_filters %}

{% block content %}
<h1 class="text-center">Treatments for Experiment: {{ experiment.Experiment_ID }}</h1>

<form id="treatments-form" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <table border="1">
    <thead>
      <tr>
        <th>Treatment ID</th>
        <th>Experiment ID</th>
        <th>Interaction 1 Value</th>
        <th>Interaction 2 Value</th>
        <th>Interaction 3 Value</th>
        <th>No of Replications</th>
        <th>Metadata</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="treatments-table">
      {% for treatment in treatments %}
      <tr id="treatment-row-{{ treatment.Treatment_ID }}">
        <td>{{ treatment.Treatment_ID }}</td>
        <td>{{ experiment.Experiment_ID }}</td>
        <td>
          <input type="text" name="interaction_1_value_{{ treatment.Treatment_ID }}" value="{{ treatment.Interaction_1_Value }}" disabled>
        </td>
        <td>
          <input type="text" name="interaction_2_value_{{ treatment.Treatment_ID }}" value="{{ treatment.Interaction_2_Value }}" disabled>
        </td>
        <td>
          <input type="text" name="interaction_3_value_{{ treatment.Treatment_ID }}" value="{{ treatment.Interaction_3_Value }}" disabled>
        </td>
        <td>
          <input type="text" name="no_of_replication_{{ treatment.Treatment_ID }}" value="{{ treatment.No_of_Replication }}" disabled>
        </td>
        <td>
          <input type="text" name="metadata_{{ treatment.Treatment_ID }}" value="{{ treatment.MetaData }}" disabled>
        </td>
        <td>
          <button type="button" onclick="enableEditing('{{ treatment.Treatment_ID }}')">Modify</button>
          <button type="button" onclick="deleteTreatment('{{ treatment.Treatment_ID }}')">Delete</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <button type="button" onclick="addNewRow()">Add Row</button>
  <button type="button" onclick="submitTreatments()">Submit All</button>
  <button type="button" onclick="window.location.href='{% url "show_treatments" experiment.Experiment_ID %}?download=true'">Download CSV</button>
</form>

<form id="upload-form" method="post" enctype="multipart/form-data" action="{% url 'show_treatments' experiment.Experiment_ID %}">
  {% csrf_token %}
  <input type="file" name="csv_file" id="csv_file" accept=".csv" onchange="handleFileUpload(event)">
  <button type="submit">Upload CSV</button>
  <div id="uploaded-file-info" style="display: {% if uploaded_file_name %}block{% else %}none{% endif %};">
    <p>Uploaded file: <span id="uploaded-file-name">{{ uploaded_file_name }}</span></p>
    <a id="uploaded-file-link" href="{{ uploaded_file_path }}" download>Download uploaded file</a>
  </div>
</form>

<div id="success-message" style="color: green; display: none;">
  Treatments added successfully!
</div>

<div id="plot-tables-section" class="flex-container">
  {% for treatment in treatments %}
  <div id="plot-table-{{ treatment.Treatment_ID }}" class="card">
    <h3>Treatment-{{ treatment.Treatment_ID }}</h3>
    <p>Interaction Values: {{ treatment.Interaction_1_Value }}, {{ treatment.Interaction_2_Value }}, {{ treatment.Interaction_3_Value }}</p>
    <table border="1">
      <thead>
        <tr>
          <th>Replication ID</th>
          <th>Plot ID</th>
        </tr>
      </thead>
      <tbody>
        {% for i in treatment.No_of_Replication|range_filter %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td><input type="text" name="plot_id_{{ treatment.Treatment_ID }}_{{ forloop.counter }}" value="{% if plot_data %}{{ plot_data.treatment_id.forloop.counter }}{% endif %}" id="plot_id_{{ treatment.Treatment_ID }}_{{ forloop.counter }}"></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button type="button" onclick="savePlotTable('{{ treatment.Treatment_ID }}')">Save</button>
  </div>
  {% endfor %}
</div>

<script>
let deletedTreatments = [];
let maxTreatmentId = Math.max(...Array.from(document.querySelectorAll('#treatments-table tr')).map(row => parseInt(row.querySelector('td:first-child').innerText.match(/\d+/)[0], 10))) || 0;

document.addEventListener("DOMContentLoaded", function() {
    console.log("DOM fully loaded and parsed. Fetching plot data...");
    document.querySelectorAll('.card').forEach(function(card) {
        let treatmentId = card.id.split('-')[2];
        fetchPlotData(treatmentId);
    });
});

function fetchPlotData(treatmentId) {
    console.log(`Fetching plot data for treatment ID: ${treatmentId}`);
    fetch(`/treatment/${treatmentId}/get_plot_data/`)
    .then(response => response.json())
    .then(data => {
      console.log("Plot data", data);
        if (data.success) {
            console.log(`Plot data retrieved for treatment ID ${treatmentId}:`, data.plot_data);
            for (let replicationId in data.plot_data) {
                console.log(`Setting value for plot_id_${treatmentId}_${replicationId}: ${data.plot_data[replicationId]}`);
                document.querySelector(`#plot_id_${treatmentId}_${replicationId}`).value = data.plot_data[replicationId];
            }
        } else {
            console.error('Error fetching plot data:', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function enableEditing(treatmentId) {
    document.querySelector(`[name="interaction_1_value_${treatmentId}"]`).disabled = false;
    document.querySelector(`[name="interaction_2_value_${treatmentId}"]`).disabled = false;
    document.querySelector(`[name="interaction_3_value_${treatmentId}"]`).disabled = false;
    document.querySelector(`[name="no_of_replication_${treatmentId}"]`).disabled = false;
    document.querySelector(`[name="metadata_${treatmentId}"]`).disabled = false;
}

function deleteTreatment(treatmentId) {
    const row = document.getElementById(`treatment-row-${treatmentId}`);
    row.parentNode.removeChild(row);
    deletedTreatments.push(treatmentId);
}

function addNewRow() {
    const newTreatmentId = `t${maxTreatmentId + 1}e{{ experiment.Experiment_ID }}`; // Increment the maximum existing Treatment ID by 1
    maxTreatmentId += 1; // Update the maxTreatmentId for subsequent new rows

    const newRow = document.createElement('tr');
    newRow.id = `treatment-row-${newTreatmentId}`;

    newRow.innerHTML = `
      <td>${newTreatmentId}</td>
      <td>{{ experiment.Experiment_ID }}</td>
      <td><input type="text" name="interaction_1_value_${newTreatmentId}" value=""></td>
      <td><input type="text" name="interaction_2_value_${newTreatmentId}" value=""></td>
      <td><input type="text" name="interaction_3_value_${newTreatmentId}" value=""></td>
      <td><input type="text" name="no_of_replication_${newTreatmentId}" value=""></td>
      <td><input type="text" name="metadata_${newTreatmentId}" value=""></td>
      <td>
        <button type="button" onclick="enableEditing('${newTreatmentId}')">Modify</button>
        <button type="button" onclick="deleteTreatment('${newTreatmentId}')">Delete</button>
      </td>
    `;

    document.getElementById('treatments-table').appendChild(newRow);

    const newPlotTable = document.createElement('div');
    newPlotTable.id = `plot-table-${newTreatmentId}`;
    newPlotTable.classList.add('card');
    newPlotTable.innerHTML = `
      <h3>Treatment-${newTreatmentId}</h3>
      <p>Interaction Values: <span id="interaction-values-${newTreatmentId}"></span></p>
      <table border="1">
        <thead>
          <tr>
            <th>Replication ID</th>
            <th>Plot ID</th>
          </tr>
        </thead>
        <tbody>
          <!-- Placeholder for new plots -->
          <tr>
            <td>1</td>
            <td><input type="text" name="plot_id_${newTreatmentId}_1" value=""></td>
          </tr>
          <tr>
            <td>2</td>
            <td><input type="text" name="plot_id_${newTreatmentId}_2" value=""></td>
          </tr>
        </tbody>
      </table>
      <button type="button" onclick="savePlotTable('${newTreatmentId}')">Save</button>
    `;
    document.getElementById('plot-tables-section').appendChild(newPlotTable);
}

function enableAllInputs() {
    document.querySelectorAll('#treatments-table input').forEach(input => {
        input.disabled = false;
    });
}

function submitTreatments() {
    enableAllInputs();  // Ensure inputs are enabled
    const formData = new FormData(document.getElementById('treatments-form'));
    const treatmentsData = [];
    const csrfToken = formData.get('csrfmiddlewaretoken');

    document.querySelectorAll('#treatments-table tr').forEach(row => {
        const treatmentId = row.querySelector('td:first-child').innerText;
        const interaction_1_value = formData.get(`interaction_1_value_${treatmentId}`)?.trim() || '';
        const interaction_2_value = formData.get(`interaction_2_value_${treatmentId}`)?.trim() || '';
        const interaction_3_value = formData.get(`interaction_3_value_${treatmentId}`)?.trim() || '';
        const no_of_replication = formData.get(`no_of_replication_${treatmentId}`)?.trim() || '';
        const metadata = formData.get(`metadata_${treatmentId}`)?.trim() || '';

        treatmentsData.push({
            treatment_id: treatmentId,
            interaction_1_value: interaction_1_value,
            interaction_2_value: interaction_2_value,
            interaction_3_value: interaction_3_value,
            no_of_replication: no_of_replication,
            metadata: metadata
        });
    });

    fetch('{% url "show_treatments" experiment.Experiment_ID %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            action: 'submit_all',
            treatments: treatmentsData,
            deleted_treatments: deletedTreatments
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('success-message').style.display = 'block';
            setTimeout(() => {
                document.getElementById('success-message').style.display = 'none';
                window.location.reload();
            }, 3000);
        } else {
            alert('Error submitting treatments: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting treatments. Please try again.');
    });
}

document.getElementById('upload-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(this);
    const csrfToken = formData.get('csrfmiddlewaretoken');
    fetch(this.action, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('success-message').style.display = 'block';
            setTimeout(() => {
                document.getElementById('success-message').style.display = 'none';
                window.location.reload();
            }, 3000);
        } else {
            alert('Error uploading CSV: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error uploading CSV. Please try again.');
    });
});

function handleFileUpload(event) {
    const fileName = event.target.files[0].name;
    document.getElementById('uploaded-file-name').textContent = fileName;
    document.getElementById('uploaded-file-link').href = URL.createObjectURL(event.target.files[0]);
    document.getElementById('uploaded-file-info').style.display = 'block';
}

function savePlotTable(treatmentId) {
    const plotData = [];
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    document.querySelectorAll(`#plot-table-${treatmentId} tbody tr`).forEach(row => {
        const replicationId = row.querySelector('td:first-child').innerText;
        const plotId = row.querySelector('input').value.trim();

        plotData.push({
            replication_id: replicationId,
            plot_id: plotId
        });
    });

    fetch(`/treatment/${treatmentId}/save_plot_data/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            plot_data: plotData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Plot data saved successfully!');
            location.reload();  // Reload the page to display updated plot data
        } else {
            alert('Error saving plot data: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving plot data. Please try again.');
    });
}
</script>

<style>
  .flex-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }

  .card {
    border: 1px solid #ccc;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    width: 300px;
  }

  .card h3 {
    margin-top: 0;
  }

  .card table {
    width: 100%;
  }

  #uploaded-file-info {
    margin-top: 10px;
  }
</style>

{% endblock %}
