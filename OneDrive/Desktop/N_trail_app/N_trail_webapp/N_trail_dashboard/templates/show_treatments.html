{% block content %}
<h1>Treatments for Experiment: {{ experiment.Experiment_ID }}</h1>

<form id="treatments-form">
  {% csrf_token %}
  <table border="1">
    <thead>
      <tr>
        <th>Treatment ID</th>
        <th>Experiment ID</th>
        <th>Interaction 1 Value</th>
        <th>Interaction 2 Value</th>
        <th>Interaction 3 Value</th>
        <th>No of Replications</th>
        <th>Metadata</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="treatments-table">
      {% for treatment in treatments %}
      <tr id="treatment-row-{{ treatment.Treatment_ID }}">
        <td>{{ treatment.Treatment_ID }}</td>
        <td>{{ experiment.Experiment_ID }}</td>
        <td>
          <input type="text" name="interaction_1_value_{{ treatment.Treatment_ID }}" value="{{ treatment.Interaction_1_Value }}" disabled>
        </td>
        <td>
          <input type="text" name="interaction_2_value_{{ treatment.Treatment_ID }}" value="{{ treatment.Interaction_2_Value }}" disabled>
        </td>
        <td>
          <input type="text" name="interaction_3_value_{{ treatment.Treatment_ID }}" value="{{ treatment.Interaction_3_Value }}" disabled>
        </td>
        <td>
          <input type="text" name="no_of_replication_{{ treatment.Treatment_ID }}" value="{{ treatment.No_of_Replication }}" disabled>
        </td>
        <td>
          <input type="text" name="metadata_{{ treatment.Treatment_ID }}" value="{{ treatment.MetaData }}" disabled>
        </td>
        <td>
          <button type="button" onclick="enableEditing('{{ treatment.Treatment_ID }}')">Modify</button>
          <button type="button" onclick="deleteTreatment('{{ treatment.Treatment_ID }}')">Delete</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <button type="button" onclick="addNewRow()">Add Row</button>
  <button type="button" onclick="submitTreatments()">Submit All</button>
</form>

<div id="success-message" style="color: green; display: none;">
  Treatments added successfully!
</div>

<script>
  let deletedTreatments = [];
  let maxTreatmentId = Math.max(...Array.from(document.querySelectorAll('#treatments-table tr')).map(row => parseInt(row.querySelector('td:first-child').innerText.match(/\d+/)[0], 10)));

  function enableEditing(treatmentId) {
    document.querySelector(`[name="interaction_1_value_${treatmentId}"]`).disabled = false;
    document.querySelector(`[name="interaction_2_value_${treatmentId}"]`).disabled = false;
    document.querySelector(`[name="interaction_3_value_${treatmentId}"]`).disabled = false;
    document.querySelector(`[name="no_of_replication_${treatmentId}"]`).disabled = false;
    document.querySelector(`[name="metadata_${treatmentId}"]`).disabled = false;
  }

  function deleteTreatment(treatmentId) {
    const row = document.getElementById(`treatment-row-${treatmentId}`);
    row.parentNode.removeChild(row);
    deletedTreatments.push(treatmentId);
  }

  function addNewRow() {
    const newTreatmentId = `t${maxTreatmentId + 1}e{{ experiment.Experiment_ID }}`; // Increment the maximum existing Treatment ID by 1
    maxTreatmentId += 1; // Update the maxTreatmentId for subsequent new rows

    const newRow = document.createElement('tr');
    newRow.id = `treatment-row-${newTreatmentId}`;

    newRow.innerHTML = `
      <td>${newTreatmentId}</td>
      <td>{{ experiment.Experiment_ID }}</td>
      <td><input type="text" name="interaction_1_value_${newTreatmentId}" value=""></td>
      <td><input type="text" name="interaction_2_value_${newTreatmentId}" value=""></td>
      <td><input type="text" name="interaction_3_value_${newTreatmentId}" value=""></td>
      <td><input type="text" name="no_of_replication_${newTreatmentId}" value=""></td>
      <td><input type="text" name="metadata_${newTreatmentId}" value=""></td>
      <td>
        <button type="button" onclick="enableEditing('${newTreatmentId}')">Modify</button>
        <button type="button" onclick="deleteTreatment('${newTreatmentId}')">Delete</button>
      </td>
    `;

    document.getElementById('treatments-table').appendChild(newRow);
  }

  function enableAllInputs() {
    document.querySelectorAll('#treatments-table input').forEach(input => {
      input.disabled = false;
    });
  }

  function submitTreatments() {
    enableAllInputs();  // Ensure inputs are enabled
    const formData = new FormData(document.getElementById('treatments-form'));
    const treatmentsData = [];
    const csrfToken = formData.get('csrfmiddlewaretoken');

    document.querySelectorAll('#treatments-table tr').forEach(row => {
      const treatmentId = row.querySelector('td:first-child').innerText;
      const interaction_1_value = formData.get(`interaction_1_value_${treatmentId}`)?.trim() || '';
      const interaction_2_value = formData.get(`interaction_2_value_${treatmentId}`)?.trim() || '';
      const interaction_3_value = formData.get(`interaction_3_value_${treatmentId}`)?.trim() || '';
      const no_of_replication = formData.get(`no_of_replication_${treatmentId}`)?.trim() || '';
      const metadata = formData.get(`metadata_${treatmentId}`)?.trim() || '';

      treatmentsData.push({
        treatment_id: treatmentId,
        interaction_1_value: interaction_1_value,
        interaction_2_value: interaction_2_value,
        interaction_3_value: interaction_3_value,
        no_of_replication: no_of_replication,
        metadata: metadata
      });
    });

    fetch('{% url "show_treatments" experiment.Experiment_ID %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        action: 'submit_all',
        treatments: treatmentsData,
        deleted_treatments: deletedTreatments // Send deleted treatments as well
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('success-message').style.display = 'block';
        setTimeout(() => {
          document.getElementById('success-message').style.display = 'none';
          window.location.reload(); // Reload the page to reflect changes
        }, 3000); // Hide the message after 3 seconds
      } else {
        alert('Error submitting treatments: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error submitting treatments. Please try again.');
    });
  }
</script>

{% endblock %}
