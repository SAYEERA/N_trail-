{% extends 'base.html' %}
{% load static %}
{% block content %}

<h1>My Projects</h1>

<!-- Display Project Table -->
<table border="1" id="project-table">
  <tr>
    <th>Project ID</th>
    <th>User ID</th>
    <th>Start Year</th>
    <th>Interactions Count</th>
    <th>Interactions_1</th>
    <th>Interactions_2</th>
    <th>Interactions_3</th>
    <th>Crop</th>
    <th>Number of Years</th>
    <th>Project Editors</th>
    <th>Funding Source</th>
    <th>Metadata</th>
    <th>View Type</th>
    <th>Experiments</th>
  </tr>
  {% for project in projects %}
  <tr>
    <td>{{ project.Project_ID }}</td>
    <td>{{ project.User_ID }}</td>
    <td>{{ project.Start_year }}</td>
    <td>{{ project.Interactions_count }}</td>
    <td>{{ project.Interaction_1 }}</td>
    <td>{{ project.Interaction_2 }}</td>
    <td>{{ project.Interaction_3 }}</td>
    <td>{{ project.Crop }}</td>
    <td>{{ project.No_of_Year }}</td>
    <td>{{ project.Project_Editors }}</td>
    <td>{{ project.Funding_Source }}</td>
    <td>{{ project.MetaData }}</td>
    <td>{{ project.View_Type }}</td>
    <td><a href="{% url 'show_experiments' project_id=project.Project_ID %}">Show</a></td>
  </tr>
  {% endfor %}
</table>

<!-- Add Project Button -->
{% if user.is_superuser %}
<button id="add-project-button">Add Project</button>
{% endif %}

<!-- Add Project Form -->
<div id="add-project-form" style="display: none;">
  <h2>Add Project Details</h2>
  <form method="post" id="project-form">
    {% csrf_token %}

    <label for="Project_ID">Project ID:</label>
    <input type="text" id="Project_ID" name="Project_ID" required><br>
   
    <label for="Start_year">Start Year:</label>
    <input type="number" id="Start_year" name="Start_year" required><br>

    <label for="Interactions_count">Interactions Count:</label>
    <input type="number" id="Interactions_count" name="Interactions_count" required><br>

    <div id="interaction-fields">
      <!-- Interaction fields will be added here dynamically -->
    </div>

    <!-- Crop dropdown -->
    <label for="Crop">Crop:</label>
    <select id="Crop" name="Crop" required>
      {% for choice in crop_choices %}
        <option value="{{ choice.0 }}">{{ choice.1 }}</option>
      {% endfor %}
    </select><br>

    <div style="display: none;">
      <label for="No_of_Year">Number of Years:</label>
      <input type="hidden" id="No_of_Year" name="No_of_Year" required readonly>
    </div>

    {% if user.is_superuser %}
    <label for="Project_Editors">Project Editors:</label>
    <div id="project-editors-container">
      <select id="Project_Editors_Select">
        {% for user in users %}
          <option value="{{ user.email }}">{{ user.email }}</option>
        {% endfor %}
      </select>
      <button type="button" id="add-project-editor">Add</button>
      <ul id="project-editors-list"></ul>
      <input type="hidden" id="Project_Editors" name="Project_Editors" ><br>
    </div>
    {% endif %}

    <label for="Funding_Source">Funding Source:</label>
    <div id="funding-source-container">
      <input type="text" id="Funding_Source_Input">
      <button type="button" id="add-funding-source">Add</button>
    </div>
    <ul id="funding-source-list"></ul>
    <input type="hidden" id="Funding_Source" name="Funding_Source" ><br>

    <label for="MetaData">Metadata:</label>
    <textarea id="MetaData" name="MetaData" rows="4" cols="50" required></textarea><br>

    <!-- View Type dropdown -->
    <label for="View_Type">View Type:</label>
    <select id="View_Type" name="View_Type" required>
      <option value="private">Private</option>
      <option value="protected">Protected</option>
    </select><br>

    <button type="submit" id="submit-button">Submit</button>
    <span id="success-message" style="color: green; display: none;">Project added successfully!</span>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const interactionChoices = [
        'Select', 'Timing', 'Inhibitor', 'N_rate', 'Landscape', 'Biological',
        'Cover_Crop', 'Crop_Rotation', 'Fall_N_Rate', 'Previous_N_Rate',
        'Grazing', 'Spring_N_Rate', 'other'
    ];

    let fundingSources = [];
    let projectEditors = [];

    // Show the add project form when the button is clicked
    document.querySelector('#add-project-button').addEventListener('click', function() {
        document.querySelector('#add-project-form').style.display = 'block';
    });

    // Handle form submission via AJAX
    document.querySelector('#project-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the default form submission

        // Client-side validation: Ensure all required fields are filled
        const requiredFields = document.querySelectorAll('#project-form [required]');
        let allFieldsFilled = true;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                allFieldsFilled = false;
                field.style.border = '2px solid red';
            } else {
                field.style.border = '';
            }
        });

        if (projectEditors.length === 0 || fundingSources.length === 0) {
            alert('Please fill Project editor/ funding source fields.');
            return;
        }

        if (!allFieldsFilled) {
            alert('Please fill all required fields.');
            return;
        }

        // Update hidden fields with concatenated values
        const projectEditorsField = document.querySelector('#Project_Editors');
        projectEditorsField.value = projectEditors.join(',');
        const fundingSourceField = document.querySelector('#Funding_Source');
        fundingSourceField.value = fundingSources.join(',');

        const formData = new FormData(this);
        // Send a POST request to the server-side URL
        fetch('{% url "add_project" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('#success-message').style.display = 'inline';
                document.querySelector('#project-form').reset(); // Reset the form fields
                document.querySelector('#add-project-form').style.display = 'none'; // Hide the form

                // Reset the fundingSources and projectEditors arrays
                fundingSources = [];
                projectEditors = [];
                document.querySelector('#funding-source-list').innerHTML = '';
                document.querySelector('#project-editors-list').innerHTML = '';

                // Refresh the page
                window.location.reload();
            } else {
                alert('Failed to add project: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add project. Please try again.');
        });
    });

    // Update interaction fields dynamically based on Interactions Count
    document.querySelector('#Interactions_count').addEventListener('change', function() {
        const count = parseInt(this.value);
        const interactionFieldsContainer = document.querySelector('#interaction-fields');
        interactionFieldsContainer.innerHTML = ''; // Clear existing fields

        for (let i = 1; i <= count; i++) {
            const label = document.createElement('label');
            label.setAttribute('for', `Interaction_${i}`);
            label.textContent = `Interaction ${i}:`;
            interactionFieldsContainer.appendChild(label);

            const select = document.createElement('select');
            select.setAttribute('id', `Interaction_${i}`);
            select.setAttribute('name', `Interaction_${i}`);
            select.required = true;

            // Add the default empty option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select an option';
            select.appendChild(defaultOption);

            interactionChoices.forEach(choice => {
                const option = document.createElement('option');
                option.value = choice;
                option.textContent = choice;
                select.appendChild(option);
            });
            interactionFieldsContainer.appendChild(select);

            // Create an input field for entering details when "other" is selected
            const otherInput = document.createElement('input');
            otherInput.setAttribute('type', 'text');
            otherInput.setAttribute('id', `Interaction_${i}_other`);
            otherInput.setAttribute('name', `Interaction_${i}_other`);
            otherInput.setAttribute('style', 'display:none;');
            interactionFieldsContainer.appendChild(otherInput);

            // Event listener to show/hide the other input field
            select.addEventListener('change', function() {
                if (this.value === 'other') {
                    otherInput.style.display = 'block';
                } else {
                    otherInput.style.display = 'none';
                }
            });

            interactionFieldsContainer.appendChild(document.createElement('br'));
        }
    });

    // Update number of years based on start year
    document.querySelector('#Start_year').addEventListener('input', function() {
        const startYear = parseInt(this.value);
        const currentYear = new Date().getFullYear();
        const numberOfYears = currentYear - startYear + 1; // Calculate number of years
        document.querySelector('#No_of_Year').value = numberOfYears > 0 ? numberOfYears : 0;
    });

    // Add funding source
    document.querySelector('#add-funding-source').addEventListener('click', function() {
        const fundingSourceInput = document.querySelector('#Funding_Source_Input');
        const fundingSource = fundingSourceInput.value.trim();
        if (fundingSource) {
            fundingSources.push(fundingSource);
            const listItem = document.createElement('li');
            listItem.textContent = fundingSource;
            document.querySelector('#funding-source-list').appendChild(listItem);
            fundingSourceInput.value = ''; // Clear the input field
        }
        // Log funding sources for debugging
        console.log('Funding Sources Array:', fundingSources);
    });

    {% if user.is_superuser %}
    // Add project editor
    document.querySelector('#add-project-editor').addEventListener('click', function() {
        const projectEditorSelect = document.querySelector('#Project_Editors_Select');
        const projectEditor = projectEditorSelect.value.trim();
        if (projectEditor && !projectEditors.includes(projectEditor)) {
            projectEditors.push(projectEditor);
            const listItem = document.createElement('li');
            listItem.textContent = projectEditor;
            const removeButton = document.createElement('button');
            removeButton.textContent = 'Remove';
            removeButton.type = 'button';
            removeButton.addEventListener('click', function() {
                const index = projectEditors.indexOf(projectEditor);
                if (index > -1) {
                    projectEditors.splice(index, 1);
                }
                listItem.remove();
            });
            listItem.appendChild(removeButton);
            document.querySelector('#project-editors-list').appendChild(listItem);
        }
        // Log project editors for debugging
        console.log('Project Editors Array:', projectEditors);
    });
    {% endif %}
});
</script>
{% endblock %}
